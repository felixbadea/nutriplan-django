{% extends "core/base.html" %}
{% load static %}

{% block title %}Plan Alimentar Personalizat{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/home.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="card-header text-white text-center py-4 rounded-top-4"
                    style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h1 class="mb-0 fw-bold">Plan Alimentar Personalizat</h1>
                    <p class="mb-0 mt-2 opacity-90">Calculat după nevoile tale reale</p>
                </div>

                <div class="card-body p-5">
                    <form hx-post="{% url 'generate-plan' %}" hx-target="#result" hx-swap="outerHTML"
                        hx-indicator="#loading" class="needs-validation" novalidate>

                        {% csrf_token %}

                        <div class="row g-4">
                            <!-- VÂRSTĂ -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Vârsta</label>
                                <input type="number" name="age" class="form-control form-control-lg" required min="18"
                                    max="100" placeholder="ex: 30">
                            </div>

                            <!-- GEN -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Gen</label>
                                <select name="gender" class="form-select form-select-lg" required>
                                    <option value="M">Bărbat</option>
                                    <option value="F">Femeie</option>
                                </select>
                            </div>

                            <!-- GREUTATE -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Greutate (kg)</label>
                                <input type="number" step="0.1" name="weight" class="form-control form-control-lg"
                                    required placeholder="ex: 75.5">
                            </div>

                            <!-- ÎNĂLȚIME -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Înălțime (cm) <small
                                        class="text-muted">(opțional)</small></label>
                                <input type="number" name="height" class="form-control form-control-lg"
                                    placeholder="ex: 175">
                            </div>

                            <!-- NIVEL DE ACTIVITATE (în engleză – obligatoriu!) -->
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Nivel de activitate</label>
                                <select name="activity_level" class="form-select form-select-lg" required>
                                    <option value="sedentary">Sedentar</option>
                                    <option value="light">Ușoară</option>
                                    <option value="moderate">Moderată</option>
                                    <option value="active">Intensă</option>
                                    <option value="very_active">Foarte intensă</option>
                                </select>
                            </div>

                            <!-- RAPORT MACRO -->
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Raport Macro</label>
                                <select name="macro_ratio" class="form-select form-select-lg" required>
                                    <option value="">-- Alege un raport --</option>
                            
                                    {% for r in macro_ratios %}
                                    {% if selected_macro_id == r.id %}
                                    <option value="{{ r.id }}" data-desc="{{ r.description|escape }}"
                                        data-fiber="{{ r.fiber_recommendation|default:'14g / 1000 kcal' }}" selected>
                                        {{ r.name }} (P:{{ r.proteins }}% C:{{ r.carbs }}% G:{{ r.fats }}%)
                                    </option>
                                    {% else %}
                                    <option value="{{ r.id }}" data-desc="{{ r.description|escape }}"
                                        data-fiber="{{ r.fiber_recommendation|default:'14g / 1000 kcal' }}">
                                        {{ r.name }} (P:{{ r.proteins }}% C:{{ r.carbs }}% G:{{ r.fats }}%)
                                    </option>
                                    {% endif %}
                                    {% empty %}
                                    <option disabled>Nu există rapoarte macro în baza de date.</option>
                                    {% endfor %}
                                </select>
                            
                                <div id="macro-desc" class="macro-desc mt-3 p-4 rounded shadow-sm" style="display: none;">
                                    <p id="desc-text" class="mb-2 lead"></p>
                                    <p class="small text-muted mb-0">
                                        <strong>Fibre recomandate:</strong>
                                        <span id="fiber-info">14g / 1000 kcal</span>
                                        <em>(USDA & EFSA)</em>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100 mt-4 shadow-sm fw-semibold">
                            Generează Planul
                        </button>

                        <div id="loading" class="htmx-indicator text-center my-5">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3 text-muted fs-5">Se generează planul tău personalizat...</p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="result" class="mt-5"></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/home.js' %}"></script>
<script>
    // Validare Bootstrap
    (function () {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %}