{% extends "core/base.html" %}
{% load static %}

{% block title %}
{% if restaurant %}
Plan alimentar – {{ restaurant.name }} | NutriPlan
{% else %}
NutriPlan – Alege restaurantul tău
{% endif %}
{% endblock %}

{% block content %}
<div class="container py-5">

    {% if restaurants %}
    <!-- ==================== LANDING PRINCIPAL (/) – LISTĂ RESTAURANTE ==================== -->
    <div class="text-center mb-5 py-5">
        <h1 class="display-4 fw-bold text-primary mb-4">Bine ai venit la NutriPlan</h1>
        <p class="lead text-muted fs-4">Planuri alimentare personalizate pentru clienții restaurantelor partenere</p>
        <p class="text-muted">Alege restaurantul tău și începe călătoria spre o alimentație mai bună!</p>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for rest in restaurants %}
        <div class="col">
            <div class="card h-100 shadow-sm hover-shadow transition border-0">
                <div class="card-body text-center p-4">
                    {% if rest.logo %}
                    <img src="{{ rest.logo.url }}" alt="{{ rest.name }}" class="rounded-circle mb-3"
                        style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #667eea;">
                    {% else %}
                    <div class="bg-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center text-white fw-bold"
                        style="width: 120px; height: 120px; font-size: 2.5rem;">
                        {{ rest.name|slice:":1"|upper }}
                    </div>
                    {% endif %}

                    <h3 class="card-title h4 mb-3">{{ rest.name }}</h3>

                    {% if rest.description %}
                    <p class="text-muted small mb-4">{{ rest.description|truncatewords:20 }}</p>
                    {% else %}
                    <p class="text-muted small mb-4">Planuri alimentare personalizate</p>
                    {% endif %}

                    <a href="/{{ rest.slug }}/" class="btn btn-primary btn-lg px-5 shadow-sm">
                        Intră în {{ rest.name }}
                    </a>
                </div>
                <div class="card-footer bg-transparent text-muted small">
                    Restaurant partener NutriPlan
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-5 col-12">
            <p class="text-muted fs-5">Momentan nu există restaurante disponibile.</p>
            <p class="text-muted">Contactează-ne pentru parteneriat!</p>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- ==================== PAGINA RESTAURANTULUI SPECIFIC – FORMULAR ==================== -->
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="card-header text-white text-center py-5"
                    style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h1 class="mb-0 fw-bold display-5">Planul tău alimentar personalizat</h1>
                    <p class="mb-0 mt-2 fs-4">Pentru {{ restaurant.name }}</p>
                </div>

                <div class="card-body p-5">
                    <form hx-post="{% url 'generate-plan' %}" hx-target="#plan-result" hx-swap="innerHTML"
                        hx-indicator="#loading" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Vârsta</label>
                                <input type="number" name="age" min="15" max="100" class="form-control form-control-lg"
                                    required placeholder="ex: 32">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Gen</label>
                                <select name="gender" class="form-select form-control-lg" required>
                                    <option value="M">Bărbat</option>
                                    <option value="F">Femeie</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Greutate (kg)</label>
                                <input type="number" name="weight" step="0.1" min="30" max="200"
                                    class="form-control form-control-lg" required placeholder="ex: 75.5">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Înălțime (cm) – opțional</label>
                                <input type="number" name="height" step="1" min="100" max="250"
                                    class="form-control form-control-lg" placeholder="ex: 175">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Nivel activitate</label>
                                <select name="activity_level" class="form-select form-control-lg" required>
                                    <option value="sedentary">Sedentar</option>
                                    <option value="light">Activitate ușoară</option>
                                    <option value="moderate">Activitate moderată</option>
                                    <option value="active">Activitate intensă</option>
                                    <option value="very_active">Foarte intensă</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Raport macronutrienți</label>
                                <select name="macro_ratio" id="macro-select" class="form-select form-control-lg"
                                    required>
                                    {% for ratio in macro_ratios %}
                                    <option value="{{ ratio.id }}" data-desc="{{ ratio.description|default:"" }}"
                                        data-fiber="{{ ratio.fiber_recommendation }}">
                                        {{ ratio.name }} → P:{{ ratio.proteins }}% | C:{{ ratio.carbs }}% | G:{{
                                        ratio.fats }}%
                                    </option>
                                    {% endfor %}
                                </select>

                                <!-- Descriere macro – se activează prin JS din global.js -->
                                <div id="macro-desc" class="macro-desc p-3 mt-3 rounded"
                                    style="display: none; background: #f8f9fa;">
                                    <p id="desc-text" class="lead mb-2"></p>
                                    <p class="small text-muted mb-0">
                                        <strong>Fibre recomandate:</strong> <span id="fiber-info">14g / 1000 kcal</span>
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Greutate țintă (kg) – opțional</label>
                                <input type="number" name="target_weight" step="0.1" min="40" max="150"
                                    class="form-control form-control-lg" placeholder="ex: 70">
                            </div>
                        </div>

                        <!-- ==================== RESTRICȚII ȘI PREFERINȚE ALIMENTARE ==================== -->
                        <div class="row g-4 mt-5">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary mb-4">Restricții și preferințe alimentare (opțional)
                                </h5>
                                <p class="text-muted mb-4">Bifează ce dorești – planul se va adapta automat doar la
                                    mâncăruri compatibile.</p>
                            </div>

                            <!-- Checkbox-uri cu switch Bootstrap -->
                            <div class="col-lg-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_vegan" name="is_vegan">
                                    <label class="form-check-label fw-semibold text-success" for="is_vegan">
                                        Vegan (fără produse de origine animală)
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_vegetarian"
                                        name="is_vegetarian">
                                    <label class="form-check-label fw-semibold text-success" for="is_vegetarian">
                                        Vegetarian
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_raw_vegan"
                                        name="is_raw_vegan">
                                    <label class="form-check-label fw-semibold text-success" for="is_raw_vegan">
                                        Raw-Vegan
                                    </label>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_gluten_free"
                                        name="is_gluten_free">
                                    <label class="form-check-label fw-semibold text-warning" for="is_gluten_free">
                                        Fără gluten
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_lactose_free"
                                        name="is_lactose_free">
                                    <label class="form-check-label fw-semibold text-warning" for="is_lactose_free">
                                        Fără lactoză
                                    </label>
                                </div>
                            </div>

                            <!-- Select multiplu pentru alergeni -->
                            <div class="col-12">
                                <label for="allergens" class="form-label fw-semibold text-danger">Alergii
                                    alimentare</label>
                                <select name="allergens" id="allergens" class="form-select form-select-lg" multiple
                                    size="6">
                                    {% for allergen in allergens %}
                                    <option value="{{ allergen.id }}">{{ allergen.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text mt-2">
                                    <small>Ține apăsat <kbd>Ctrl</kbd> (Windows) sau <kbd>Cmd</kbd> (Mac) pentru a
                                        selecta mai multe alergii.</small>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-5">
                            <button type="submit" class="btn btn-primary btn-lg px-5 shadow-lg">
                                Generează Planul Meu
                            </button>
                        </div>

                        <div id="loading" class="htmx-indicator text-center my-5">
                            <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
                            <p class="mt-3 fs-4 text-muted">Se creează planul tău perfect...</p>
                        </div>
                    </form>

                    <div id="plan-result" class="mt-5"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>


{% endblock %}
{% block extra_js %}
<script>
    // Validări și logică inteligentă pentru checkbox-urile dietetice
    document.addEventListener('DOMContentLoaded', function () {
        const veganCheckbox = document.getElementById('is_vegan');
        const vegetarianCheckbox = document.getElementById('is_vegetarian');
        const rawVeganCheckbox = document.getElementById('is_raw_vegan');
        const glutenFreeCheckbox = document.getElementById('is_gluten_free');
        const lactoseFreeCheckbox = document.getElementById('is_lactose_free');

        if (!veganCheckbox || !vegetarianCheckbox || !rawVeganCheckbox) return;

        // Funcție helper pentru a actualiza starea
        function updateDependencies() {
            if (rawVeganCheckbox.checked) {
                // Raw-Vegan implică Vegan + Vegetarian + Fără lactoză
                veganCheckbox.checked = true;
                vegetarianCheckbox.checked = true;
                lactoseFreeCheckbox.checked = true;
            } else if (veganCheckbox.checked) {
                // Vegan implică Vegetarian + Fără lactoză
                vegetarianCheckbox.checked = true;
                lactoseFreeCheckbox.checked = true;
            }
        }

        // Evenimente la schimbare
        rawVeganCheckbox.addEventListener('change', function () {
            updateDependencies();
        });

        veganCheckbox.addEventListener('change', function () {
            if (!veganCheckbox.checked) {
                // Dacă debifezi Vegan → debifezi Raw-Vegan
                rawVeganCheckbox.checked = false;
            }
            updateDependencies();
        });

        vegetarianCheckbox.addEventListener('change', function () {
            if (!vegetarianCheckbox.checked) {
                // Dacă debifezi Vegetarian → debifezi Vegan și Raw-Vegan
                veganCheckbox.checked = false;
                rawVeganCheckbox.checked = false;
            }
            updateDependencies();
        });

        lactoseFreeCheckbox.addEventListener('change', function () {
            if (veganCheckbox.checked && !lactoseFreeCheckbox.checked) {
                // Nu poți debifa Fără lactoză dacă ești Vegan
                lactoseFreeCheckbox.checked = true;
                alert("Notă: Dieta vegană exclude automat lactoza. Această opțiune rămâne bifată.");
            }
        });

        // Inițializare la încărcarea paginii (în caz că utilizatorul revine cu date salvate)
        updateDependencies();
    });
</script>
{% endblock %}
